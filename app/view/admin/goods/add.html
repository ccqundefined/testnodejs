<%- include ../public/page_header.html %>
    <!-- 前提必须引入jQuery -->
    <!-- 富文本编辑器 -->
    <link href="/public/admin/wysiwyg-editor/css/froala_editor.pkgd.min.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" src="/public/admin/wysiwyg-editor/js/froala_editor.pkgd.min.js"></script>
    <script type="text/javascript" src="/public/admin/wysiwyg-editor/js/zh_cn.js"></script>

    <!-- 批量上传图片插件 -->
    <link rel="stylesheet" type="text/css" href="/public/admin/webuploader/css/webuploader.css">
    <script type="text/javascript" src="/public/admin/webuploader/js/webuploader.js"></script>
    <div class="panel panel-default">
        <div class="panel-body">
            <div class="table-responsive input-form">
                <form action="/admin/goods/doAdd?_csrf=<%=csrf%>" method="post" class="goods_content" enctype="multipart/form-data">
                    <input type="hidden" name="_csrf" value="<%=csrf%>" id="csrf" />
                    <ul class="nav nav-tabs" role="tablist">
                        <li role="presentation" class="active"><a href="#general" role="tab" data-toggle="tab">通用信息</a>
                        </li>
                        <li role="presentation"><a href="#detail" role="tab" data-toggle="tab">详细描述</a></li>
                        <li role="presentation"><a href="#mix" role="tab" data-toggle="tab">其他信息</a></li>
                        <li role="presentation"><a href="#attribute" role="tab" data-toggle="tab">规格与包装</a></li>
                        <li role="presentation"><a href="#photo" role="tab" data-toggle="tab">商品相册</a></li>
                    </ul>

                    <!-- Tab panes -->
                    <div class="tab-content">
                        <div role="tabpanel" class="tab-pane active" id="general">
                            <ul class="form_input">
                                <li><span class="form-title">商品标题:</span> <input type="text" class="input" name="title"
                                        class="title"></li>
                                <li><span class="form-title">附属标题:</span> <input type="text" class="input"
                                        name="sub_title" class="title"></li>
                                <li><span class="form-title">商品版本:</span> <input type="text" class="input"
                                        name="goods_version" class="title"></li>
                                <li>
                                    <span class="form-title">所属分类:</span> <select name="cate_id" id="cate_id">
                                        <%for(var i=0; i<goodsCate.length; i++){%>
                                            <option value="<%=goodsCate[i]._id%>">
                                                <%=goodsCate[i].title%>
                                            </option>
                                            <%for(var j=0; j<goodsCate[i].items.length; j++){%>
                                                <option value="<%=goodsCate[i].items[j]._id%>">---
                                                    <%=goodsCate[i].items[j].title%>
                                                </option>
                                                <%}%>
                                                    <%}%>
                                    </select>
                                    <input type="hidden" name="cname" id="cname">
                                </li>
                                <li><span class="form-title">商品图片:</span> <input type="file" name="goods_img"></li>
                                <li><span class="form-title">商品价格:</span> <input type="text" name="shop_price"></li>
                                <li><span class="form-title">商品原价:</span> <input type="text" name="market_price"></li>
                                <li><span class="form-title">商品状态:</span> <input type="radio" name="status" value="1"
                                        checked>显示
                                    <input type="radio" name="status" value="0" checked>隐藏
                                </li>
                                <li>
                                    <span class="form-title">加入推荐:</span>
                                    <input type="checkbox"  name="is_best" value="1">精品
                                    <input type="checkbox" name="is_hot" value="1">热销
                                    <input type="checkbox" name="is_new" value="1">新品
                                </li>
                            </ul>
                        </div>
                        <div role="tabpanel" class="tab-pane" id="detail">
                            <textarea name="goods_content" id="goods_content" cols="100" rows="10"></textarea>
                        </div>
                        <div role="tabpanel" class="tab-pane" id="mix">
                            <ul class="form_input">
                                <li><span class="form-title">商品颜色:</span>
                                    <%for(var i=0; i < colorResult.length; i++){%>
                                        <input type="checkbox" name="goods_color" value="<%=colorResult[i]._id%>"
                                            id="color_<%=colorResult[i]._id%>"><label
                                            for="color_<%=colorResult[i]._id%>">
                                            <%=colorResult[i].color_name%>
                                        </label>
                                        <%}%>
                                            <i>填写关联商品的id多个以逗号隔开 格式:23,24,29</i>
                                </li>
                                <li><span class="form-title">关联商品:</span> <input type="text" name="relation_goods"
                                        class="title"><i>填写关联商品的id多个以逗号隔开 格式:23,24,29</i></li>
                                <li><span class="form-title">关联赠品:</span> <input type="text" name="goods_gift"
                                        class="title"><i>填写关联商品的id多个以逗号隔开 格式:23,24,29</i></li>
                                <li><span class="form-title">关联配件:</span> <input type="text" name="goods_fitting"
                                        class="title"><i>填写关联商品的id多个以逗号隔开 格式:23,24,29</i></li>
                                <li><span class="form-title">更多属性:</span> <input type="text" name="goods_attrs"
                                        class="title"><i>填写关联商品的id多个以逗号隔开 格式:23,24,29</i></li>
                                <li><span class="form-title">Seo关键词:</span> 
                                    <input type="text" name="goods_keywords" class="goods_keywords">
                                </li>
                                <li><span class="form-title">Seo描述:</span> 
                                    <textarea name="goods_desc" id="goods_desc" cols="100" rows="2"></textarea>
                                </li>        
                            </ul>
                        </div>
                        <div role="tabpanel" class="tab-pane" id="attribute">
                            <ul class="form_input">
                                <li><span class="form-title">商品类型:</span>
                                    <select name="goods_type_id" id="goods_type_id">
                                        <option value="0">--请选择商品类型--</option>
                                        <%for(var i=0; i < goodsType.length; i++){%>
                                            <option value="<%=goodsType[i]._id%>">
                                                <%=goodsType[i].title%>
                                            </option>
                                            <%}%>
                                    </select>
                                </li>
                            </ul>
                            <ul class="form_input" id="goods_type_attribute">

                            </ul>
                        </div>
                        <div role="tabpanel" class="tab-pane" id="photo">

                            <div id="uploader-demo">
                                <!--用来存放item-->
                                <ul id="fileList" class="clearfix"></ul>
                                <div id="filePicker">选择图片</div>
                                <div id="photoList">

                                </div>
                            </div>

                        </div>
                    </div>
                    <input type="hidden" name="_csrf" value="<%=csrf%>">
                    <button type="submit" class="btn btn-success goods_content_btn">提交</button>
                </form>
            </div>
        </div>

    </div>
    <script>
        // 关联商品类型
        $(function () {
            $('#goods_type_id').change(function () {
                // alert($(this).val());
                var cate_id = $(this).val();
                $.get('/admin/goods/goodsTypeAttribute?cate_id=' + cate_id, function (response) {
                    console.log(response.result);
                    var data = response.result;
                    var str = '';
                    for (var i = 0; i < data.length; i++) {
                        if (data[i].attr_type == 1) {
                            str += '<li><span class="form-title">' + data[i].title + ":</span><input type=hidden name=attr_id_list value=" +
                                data[i]._id + "><input type='text' name='attr_value_list'></li>"
                        } else if (data[i].attr_type == 2) {
                            str += '<li><span class="form-title">' + data[i].title + ":</span><input type=hidden name=attr_id_list value="
                                + data[i]._id + "><textarea name='attr_value_list' cols='50' rows='8'></textarea></li>"
                        } else {
                            var arr = data[i].attr_value.split('\n')
                            // console.log(arr)
                            str += '<li><span class="form-title">' + data[i].title + ":</span><input type=hidden name=attr_id_list value=" +
                                data[i]._id + ">"
                            str += '<select name="attr_value_list">'
                            for (var j = 0; j < arr.length; j++) {
                                str += '<option value="' + arr[j] + '">' + arr[j] + '</option>'
                            }
                            str += '</select>'
                            str += '</li>'
                        }
                    }
                    // console.log(str)
                    $('#goods_type_attribute').html(str);
                });
            });
        })
        var csrf = $('#csrf').val();
        // 富文本编辑器
        $(function () {
            new FroalaEditor('#goods_content', {
                height: 300, //给编辑器设置默认的高度
                language: 'zh_cn',
                //根据不同的分辨率加载不同的配置
                toolbarButtons: {
                    'moreText': {
                        'buttons': ['bold', 'italic', 'underline', 'strikeThrough', 'fontFamily', 'fontSize', 'textColor', 'backgroundColor']
                    },
                    'moreParagraph': {
                        'buttons': ['alignLeft', 'alignCenter', 'formatOLSimple', 'alignRight', 'alignJustify', 'formatOL', 'formatUL', 'paragraphFormat', 'paragraphStyle', 'lineHeight', 'outdent', 'indent', 'quote']
                    },
                    'moreRich': {
                        'buttons': ['insertLink', 'insertImage', 'insertVideo', 'insertTable', 'emoticons', 'fontAwesome', 'specialCharacters', 'embedly', 'insertFile', 'insertHR']
                    },
                    'moreMisc': {
                        'buttons': ['undo', 'redo', 'fullscreen', 'print', 'getPDF', 'spellChecker', 'selectAll', 'html', 'help'],
                        'align': 'right',
                        'buttonsVisible': 2
                    }
                },
                toolbarButtonsMD: {
                    'moreText': {
                        'buttons': ['bold', 'italic', 'underline', 'strikeThrough', 'fontFamily', 'fontSize', 'textColor', 'backgroundColor', 'inlineClass', 'inlineStyle', 'clearFormatting'],
                        'buttonsVisible': 6
                    }
                },
                toolbarButtonsMD: {
                    'moreText': {
                        'buttons': ['bold', 'italic', 'underline', 'strikeThrough', 'fontFamily', 'fontSize', 'textColor', 'backgroundColor', 'inlineClass', 'inlineStyle', 'clearFormatting'],
                        'buttonsVisible': 6
                    }
                },
                imageUploadURL: '/admin/goods/uploadImage?_csrf=' + csrf
            });
        })
        $(function () {
            // 初始化Web Uploader
            var uploader = WebUploader.create({

                // 选完文件后，是否自动上传。
                auto: true,

                // swf文件路径
                swf: '/public/admin/webuploader/flash/Uploader.swf',

                // 文件接收服务端。
                server: '/admin/goods/uploadPhoto',

                // 选择文件的按钮。可选。
                // 内部根据当前运行是创建，可能是input元素，也可能是flash.
                pick: '#filePicker',

                // 只允许选择图片文件。
                accept: {
                    title: 'Images',
                    extensions: 'gif,jpg,jpeg,bmp,png',
                    mimeTypes: 'image/*'
                }
            });
            // 当有文件添加进来的时候
            uploader.on('fileQueued', function (file) {
                var $li = $(
                    '<li id="' + file.id + '" class="img-list">' +
                    '<img class="img-responsive">' +
                    '<p class="upload_message"></p>'+
                    '</li>'
                ),
                    $img = $li.find('img');


                // $list为容器jQuery实例
                $('#fileList').append($li);

                // 创建缩略图
                // 如果为非图片文件，可以不用调用此方法。
                // thumbnailWidth x thumbnailHeight 为 100 x 100
                uploader.makeThumb(file, function (error, src) {
                    if (error) {
                        $img.replaceWith('<span>不能预览</span>');
                        return;
                    }

                    $img.attr('src', src);
                }, 300, 200);
            });
            uploader.on('uploadProgress', function (file, percentage) {
                var $li = $('#' + file.id)
                var $liHover = $('<div class="progress_active"><div class="progress_bar"><div class="progress_bgc"></div></div><div>')
                var $percent = $li.find('.progress_active .progress_bar')
                // 避免重复创建
                if (!$percent.length) {
                    $li.append($liHover);
                }

                // $li.find('p.state').text('上传中');

                $('.progress_bgc').css('width', percentage * 100 + '%');
                $('#' + file.id+' .upload_message').html('上传进度'+parseInt(percentage * 100) + '%')
            });
            uploader.on('uploadSuccess', function (file,response) {
                var photoStr = ''
                console.log(response)
                $('.progress_active').remove();
                $('#' + file.id+' .upload_message').html('上传完成')
                photoStr = '<input type="hidden" name="goods_image_list" value="'+response.link +'">'
                $('#photoList').append(photoStr);
            });
            uploader.on('uploadError', function (file) {
                // console.log('哈哈哈')
                $('.progress_active').remove();
                $('#' + file.id+' .upload_message').html('上传失败')
            });
        })


    </script>
    </body>

    </html>